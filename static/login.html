<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style>
			body{
				margin: 0;
				box-sizing: border-box;
			}
			main{
				height: 100vh;
				width: 100vw;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			header{
				z-index:100;
				position: fixed;
				width:100%;
				font-size:1.3em;
				padding:0.7em;
				color: #fff;
				background-color:#6e0139;
				flex-direction: column;
			}
			footer{
				z-index:100;
				width: 100vw;
				padding:0.7em;
				font-size: 1.1em;
				color: rgb(178, 178, 178);
				background-color:#6e0139;	
				position: fixed;
				bottom: 0;
				display: flex;
				flex-flow: row wrap;
			}
			footer p{
				font-size: 0.7em;
				margin:0;
				width: 49%;
			}
			footer a{
				color: rgb(178, 178, 178);
				font-weight: bold;

			}
			iframe{
				visibility: hidden;
				z-index: 200;
				position: fixed;
				width: 100vw;
				height: 100vh;
				background-color: rgba(50, 50,50, 0.5)
			}
			.cpc_p{
				padding: 0;
				display: flex;
				align-items: center;
				text-align: right;
				justify-content: end;
			}
			.cpc_p span{
				margin: 0 3px 0 3px;
				font-size: 1.5em;
			}
			.cpc_p a{
				margin: 0 0 0 3px;
			}
			.login-cont{
				box-sizing: border-box;
				text-align: center;
				font-size: 1.5em;
			}
			.login-cont input{
				width:8em;
				font-size: 0.8em;

			}
			#captcha-wall{
				visibility: hidden;
				z-index:50;
				position: fixed;
				display: flex;
				justify-content: center;
				align-items: center;
				width: 100vw;
				height: 100vh;
				background-color: rgba(50, 50,50, 0.5)
			}
			#captcha-cont{
				width: 25%;
				padding: 20px;
				border-radius: 10px;
				
			}
			.boton{
				border:0;
				border-radius: 10px;
				background-color: #6e0139;
				color: #fff;
				padding: 0.2em;
			}

			#captcha-img{
				border: 1px solid #000;
				width: 100%;
				height: 120px;
				margin-bottom: 10px;
				background-repeat: no-repeat;
				background-size: 100% 100%;
			}
			#error{
				display: none;
				margin:0px;
				background-color: #ff4a4a;
				width: 100%;
				height: 100%;
			}
			#captcha-input{
				font-family:'Courier New', Courier, monospace;
				width:40%;
				height: 34px;
				padding: 0;
				text-align: center;
				font-size: 1.5em;
				letter-spacing: 0.7em;
			}
		</style>
	</head>
	<body>
		<header>
			<h2 style="margin:0;">1. Ingresa tus datos de acceso del SAES</h2>
		</header>
		<main>
			<iframe id="editar" title="Editar datos personales"></iframe>
			<div id="captcha-wall">
				<section id="captcha-cont">
					<img id="captcha-img">
					<input type="text" id="captcha-input" maxlength="3"><button onclick="main('captcha')" class="boton" style="width:30%;height: 34px;float: right;">Verificar</button>
				</section>
			</div>
			<section class="login-cont">
				<table>
					<tr>
						<td style="text-align: right;">Boleta:</td>
						<td><input type="text" id="saes_usr" maxlength="13" class="test"></td>
					</tr>
					<tr>
						<td style="text-align: right;">Contrase√±a:</td>
						<td><input type="password" name="saes_psw"></td>
					</tr>
					<tr>
						<td id="status-cont" colspan="2">
							<div id="error"><p style="margin: 0px;">Error: XD</p></div>
							<!-- aqui poner captcha y errores -->
						</td>
					</tr>
					<tr>
						<td colspan="2"><div class="boton" id="botonLgn" onclick="main('getID')">Enviar datos</div></td>
					</tr>
				</table>
			</section>
		</main>
		<footer>
			<p>*datos de contacto*, , derechos de redistribucion**</p><p class="cpc_p">Hecho con <span>&hearts;</span> por el <a href="#">Club de Programacion Competitiva ESFM</a></p>
			<p><em>version 0.0.2 (23/jul/2023)</em> git:<a href="github.com">**poner el hash del ultimo push a master con href al repo**</a></p>
		</footer>
	</body>
	<script>
		clientID = "";

		function xhr(data){
			let xhttp = new XMLHttpRequest();
			let r = {"status":null,"response":null};
			xhttp.onload = function() {
				r["status"] = xhttp.status;
				r["response"] = JSON.parse(this.responseText);
			};
			xhttp.open("POST", "/xhr", true);
			xhttp.setRequestHeader('Content-type', 'application/json');
			xhttp.send(JSON.stringify(data));
			return r;
		};

		function mostrarError(info){
			let tmp = document.getElementById("error");
			tmp.style.display = "block";
			tmp.innerHTML = info;
		};

		function main(f=null){
			switch(f){
				case "getID": //Obtener ID del server
					if(document.getElementById("saes_usr").value == "" || document.getElementById("saes_psw").value == ""){
						mostrarError("Debes escribir tus credenciales de acceso para continuar");
					};
					let respID = xhr({})
					clientID = respID.id
					main("wait");
					break;
				case "wait": //Rutina de fila
					respw = xhr({"id":clientID,"req":"alive"});
					switch(respw["status"]){
						case 200: //pasar directo al captcha
							//TODO: Cuenta regresiva de 20 seg
							let tmp2 = document.getElementById("captcha-img");
							tmp2.style.backgroundImage = "url('" + respw["response"].img + "')";
							tmp2.style.visibility = "visible";
							break;			
						case 530: //seguir esperando en la fila y mostrar lugar recibido
							mostrarError("Espera por favor. Lugar en la fila: " + respw["response"].pos);
							setTimeout(() => {main("wait")}, 2500);
							break;
						case 552:
							//TODO: EL server no reconoce el ID, recargar pagina(?)
							break;
						default:
							//TODO: Mostrar un mensaje de error generico
							break;
					};
					break;
				case "captcha":
					//verificar de nuevo credenciales escritas??
					//TODO: Verificar que se haya escrito algo en el captcha-input
					let data = {"req":"captcha"};
					data["boleta"] = document.getElementById("saes_usr").value;
					data["password"] = document.getElementById("saes_psw").value;
					data["captcha"] = document.getElementById("captcha-input").value;
					let resp = xhr(data);
					if(resp["status"] == 200){
						let iframe = document.getElementById("editar");
						iframe.src = 'data:text/html;charset=utf-8,' + encodeURI(resp["respose"].html);//renderizar respuesta (editar.html) en un iframe
						//deberiamos invisibilizar todo lo demas?
						iframe.style.visibility = "visible";
					}else{
						//mostrar el error y reiniciar proceseso
					};
					break;
				default:
					//main llamado sin argumentos
					break;
			}
		};


















		function fila_loop(){
			let data = JSON.stringify({"id":clientID,"req":"alive"})
			let xhttp = new XMLHttpRequest();
			xhttp.onload = function() {
				resp = JSON.parse(this.responseText);
				switch (xhttp.status) {
					case 200:
						document.getElementById("captcha-img").style.backgroundImage = "url('" + resp.img + "')"
						//pasar directo al captcha
						//no hacer self-timeout
						document.getElementById("captcha-wall").style.visibility = "visible"
						break;
					case 530:
						let tmp = document.getElementById("error")
						tmp.style.display = "block"
						tmp.innerHTML = "Espera por favor. Lugar en la fila: " + resp.pos;
						//seguir esperando en la fila y mostrar lugar recibido
						setTimeout(() => {
							fila_loop()
						}, 3000);
						break;
					case 552:
						//el ID no esta en el server. recargar pagina
						break;
					default:
						break;
				}
			}
			xhttp.open("POST", "/xhr", true);
			xhttp.setRequestHeader('Content-type', 'application/json')
			xhttp.send(data);		
		};
	</script>
</html>